---
title: "Data Visualization Notes"
author: "Andrew Nalundasan"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8, fig.height = 5, echo = TRUE)
```


```{r install, eval = FALSE}

## This code will not be evaluated automatically.
## (Notice the eval = FALSE declaration in the options section of the
## code chunk)

my_packages <- c("tidyverse", "broom", "coefplot", "cowplot",
                 "gapminder", "GGally", "ggrepel", "ggridges", "gridExtra",
                 "here", "interplot", "margins", "maps", "mapproj",
                 "mapdata", "MASS", "quantreg", "rlang", "scales",
                 "survey", "srvyr", "viridis", "viridisLite", "devtools")

install.packages(my_packages, repos = "http://cran.rstudio.com")

```

# Set Up Project and Load Libraries

To begin we must load some libraries we will be using. If we do not load them, R will not be able to find the functions contained in these libraries. The tidyverse includes ggplot and other tools. We also load the socviz and gapminder libraries.

```{r setup, include=FALSE}

## By default, show code for all chunks in the knitted document,
## as well as the output. To override for a particular chunk
## use echo = FALSE in its options.
knitr::opts_chunk$set(echo = TRUE) 

## Set the default size of figures
knitr::opts_chunk$set(fig.width=8, fig.height=5)  

## Load the libraries we will be using
library(gapminder)
library(here)
library(tidyverse)
library(socviz)

```

# Look at Data

+ The graphs you make are meant to be looked at by someone
+ When making graphs, there is only so much that R can do to keep me on the right track
+ Need to begin cultivating my own good sense about graphs now
+ Perceptual tendencies can be honestly harnessed to make our graphics more effective
+ **Scatterplot** - shows the relationship between two quantities
+ What makes figures bad? 3 varieties:

    + Aesthetic
    + Substantive
    + Perceptual

+ Avoid content-free decoration, including chartjunk aka CLUTTER
+ Visually unique, "infographic" - style graphs are more memorable than more standard statistical visualizations
+ median > raw data

    + Rather look at the trend of an average score, rathern than the trend for the highest possible score
    
+ Relative comparisons need a stable baseline
+ Our ability to distinguish shades of brightness is not uniform
+ **Luminance** - brightness
+ **Chrominance** - intensity
+ **Diverging Scale** - where the steps away from the midpoint are perceptually even in both directions
+ **Qualitative Palette** - easiliy distinguishable colors but also have the same valence for the viewer
+ We should not pick colors in an ad hoc way
+ **Shape** and **color** are two distinct *channels* that can be used to encode information visually
+ Gestalt principles: 

    + *Proximity* - things that are spatially near to one another seem to be related
    + *Similarity* - Things that look alike seem to be related
    + *Connection* - Things that are visually tied to one another seem to be related
    + *Continuity* - Partially hidden objects are completed into familiar shapes
    + *Closure* - Incomplete shapes are perceived as complete
    + *Figure and ground* -  Visual elements are taken to be either in the foreground or in the background
    + *Common fate* - Elements sharing a direction of movement are perceived as a unit
    
+ A scatterplot is a visual *representation* of data, not a way to magically transmit pure understanding
+ There are better and worse ways of visually representing data when the task the user must perform involves estimating and comparing values within the graph
+ We tend to misjudge quantities encoded as *angles*
+ Often, the main audience for your visualizations is myself
+ Working with ggplot():

    1. Must give some information to the ggplot() function
    2. Must choose a geom_() function

# Get Started

+ *Install* package only once, but load the library() each session
+ In R, everything we deal with has a name
+ Almost everything is some kind of object
+ c() is a function: for 'combine' or 'concatenate'

    + Take a sequence of comma separate things inside the () and join them together into a vector where each element is still individually accessible
    
+ Function: special kind of object that can perform actions for me

    + Produces output based on the input it receives
    
```{r}
c(1, 2, 3, 1, 3, 5, 25)  # sends to console and output is provided

# assign to objects
my_numbers <- c(1, 2, 3, 1, 3, 5, 25)
your_numbers <- c(5, 31, 71, 1, 3, 21, 6)
```

## You do things using functions

```{r}
# practice with functions
mean(x=my_numbers)
mean(x=your_numbers)
mean(my_numbers)

my_summary <- summary(my_numbers)
my_summary
```

+ Packages save you from reinventing the wheel
+ Things are done in R by creating and manipulating named objects
+ outputs are as expected

```{r}
# operations
table(my_numbers)
sd(my_numbers)
my_numbers * 5
my_numbers + 1
my_numbers + my_numbers  # vectorized operation - vectors of the same length
```

+ *Vectorized* operation - vectors of the same length are added together (manipulated somehow)

```{r}
# practice with classes
class(my_numbers)
class(my_summary)
class(summary)

# manipulate classes
my_new_vector <- c(my_numbers, "Apple")
my_new_vector
class(my_new_vector)
```

+ Adding "Apple" changes the entire vector from *number* type to *character* type
+ Character strings cannot be used in calculations


+ *Matrix* - consists of rows and columns of numbers
+ *Data Frame* - rectangular table consisting of rows (of observations) and columns (of variables)

    + Columns can be of different classes

```{r}
titanic
class(titanic)

# selecting particular elements in a df
titanic$percent
```

+ *Tibble* - 

    + used to store variables of different classes all together in a single table of data
    + Do more to let us know about what they contain
    + More friendly when interacted with from the console
    
```{r}
titanic_tb <- as_tibble(titanic)
titanic_tb
```

+ To see inside an object, ask for its *structure*
+ *vector* is just a sequence of numbers

```{r}
str(my_numbers)
str(my_summary)
```

## Get data into R

```{r}
url <- "https://cdn.rawgit.com/kjhealy/viz-organdata/master/organdonation.csv"

organs <- read_csv(file=url)
```

+ "Column specification" - tells us that read_csv() function has assigned a class to each column of the object it created from the CSV file
+ It is helpful to know what class each column / variable is

    + A variable's class determines what sort of operations can be performed on it
    
+ read_csv() will not classify variables as *factors* unless it's told to
+ You will need to take care that any labeled variables imported into R are coded properly, so that you do not end up mistakenly using missing data in your analysis
+ "Tidy" format:

    + *long* rather than *wide* format
    + Every observation a row
    + Every variable a column
    
## Make first figure
    
```{r}
gapminder
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp))
p + geom_point()
```

# Make a Plot

+ Visualizing data with ggplot *always* involves the same sequence of steps
+ The way you use ggplot to think about the logical structure of the plot
+ *aesthetics* - logical connections between the data and the plot elements

## How Ggplot works 

+ Steps to creating ggplots: 

    1. Tell ggplot() function what the data is and how the variables in the data logically map onto the plot's aesthetics
    2. Take the result and say what general sort of plot wished to create, or *geom*
    
+ Plots: 

    + geom_point() - scatterplot
    + geom_bar() - bar plot
    + geom_boxplot() - boxplot
    
+ ggplot() + geom() yields a plot
+ the rest of it is just details

+ Specify the details: 

    + scales
    + labels
    + legends
    + axes
    + etc.

## Tidy Data

+ Tidy data:

    + *long-format* - every variable is a column, every observation is a row
    + *wide-format* - some variables are spread out across columns
    + ggplot wants data in *long-format*
    
+ tidy data is much more straightforward to work with when it comes to specifying the mappings that you need to coherently describe plots

## Mappings link data to things you see

```{r}
# look at the data
gapminder
```

+ Plot life expectancy against per capita GDP for all country-years in the data

```{r}
p <- ggplot(data = gapminder)

```

+ data still needs to be mapped
+ *mapping* - tell ggplot which variables in the data should be represented by which visual elements in the plot
+ ggplot also doesn't know what sort of plot we want (*geom*)

```{r}
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp))
```

+ here, we've given ggplot 2 arguments: 

    1. data
    2. mapping
    
+ the *data* argument tells ggplot where to find the variables it is about to use

    + any mentions of variables will be searched for in the specified *data*
    
+ *mapping* argument is not a data object, not even a character string. It's a *function*
+ this aes() function call says:

    + "The variable on the x-axis is going to be *gdpPercap* and the variable on the y-axis is going to be *lifeExp*"
    
+ *mapping = aes(...)* argument *links variables to things you will see* on the plot
+ *mapping* does not directly say what particular colors or shapes will be on the plot
+ *mapping* says which *variables* in the data will be *represented* by visual elements on the plot
+ we need to add a *layer* to the plot

```{r}
p + geom_point()
```

## Build plots layer by layer

+ Conceptually, we will always follow the same set of steps:

    1. Tell the ggplot() function what our data is
    2. Tell ggplot() *what* relationships we want to see. For convenience we will put the results of the first two steps in an object called p
    3. Tell ggplot *how* we want to see the relationships in our data
    4. Layer on geoms as needed, by adding them to the p object one at a time
    5. Use some additional function sto adjust scales, labels, tickmarks, titles. 
    
+ default plots - coordinate system typically cartesian
+ *cartesian* coordinate system - plane defined by an x-axis and a y-axis
+ typically in R - *functions* take *objects* as *inputs* and produce *objects* as *outputs*

```{r}
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp))
p + geom_smooth()
```

+ geom_smooth() calculated a smoothed line for us and shaded in a ribbon showing the standard error for the line

```{r}
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp))
p + geom_point() + geom_smooth()
```

+ see the data points and the smoothed line together. 
+ R console returns a message regarding "gam". 

    + R has fit a generalized additive model
    + This implies that there are other models that geom_smooth() understanding
    + let's try adding method = 'lm' (linear model)


```{r}
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp))
p + geom_point() + geom_smooth(method = 'lm')
```

+ It's possible to give geoms separate instructions that they will follow
+ Let's try to take the log to spread out the distribution on the left side of this plot
+ 'scale_x_log10()' - scales the x-axis of a plot to a log 10 basis


```{r}
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp))
p + geom_point() + geom_smooth(method = 'gam') + scale_x_log10()
```

+ This plot is different from in the book. 
+ To match the plot in the book, change to 'method = 'lm''.
+ scale_ functions can be applied to format the tick-marks

+ Gain access to all functions within a library, load the library via library()
+ Use just 1 function from a library, use :: to grab that specific function
+ syntax - 

    + thepackage::thefunction
    
```{r}
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp))
p + geom_point() + 
  geom_smooth(method = 'lm') + 
  scale_x_log10(labels = scales::dollar)
```

+ scale transformations: 

    1. Possible to directly transform x- or y- axis by adding something like "scale_x_log10()" or "scale_y_log10()" to the plot
        + The x- or y- axis will be transformed
        + By default, the tick-marks on the axis will be labeled using *scientific notation*
    2. Possible to gives these "scales_" functions a "labels" argument that reformats the text printed underneath the tick-marks on the axes.
    
## Mapping aesthetics vs setting them

+ *aesthetic mapping* - specifies that a variable will be expressed by one of the available visual elements, such as size, color, or shape

```{r}
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp, color = continent))
```

+ this command says "the portery 'color' will represent the variable *continent*"
+ aka - "color will map *continent*
+ if we wanted all the points to be purple, it is NOT done via *mapping* function

```{r}
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp, color = "purple"))
p + geom_point() + geom_smooth(method = "loess") + scale_x_log10()
```

+ *aesthetic* - mapping of variables in your data to properties you can see on the graph
+ aes() function is where the mapping is specified, and the function is trying to do its job

    + aes() is trying to treat "purple" as if it were a variable
    + a variable should have as many observations as there are rows in the data
    + aes() is for mappings only - do not use to change properties in a particular value
    
```{r}
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp))
p + geom_point(color = "purple") + geom_smooth(method = "loess") + scale_x_log10()
```

+ R knows what color "purple" is when passed into geom_point()

```{r}
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp))
p + geom_point(alpha = 0.3) + geom_smooth(color = "orange", se = FALSE, size = 2, method = "lm") + scale_x_log10()
```

+ updated size from 8 to 2
+ *alpha* controls how transparent the object will appear when drawn. From scale 0-1
+ transparency helps to make it easier to see where the bulk of observations are located

```{r}
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp))
p + geom_point(alpha = 0.3) + 
  geom_smooth(method = "gam") + 
  scale_x_log10(labels = scales::dollar) + 
  labs(x = "GDP Per Capita", y = "Life Expectancy in Years",
       title = "Economic Growth and Life Expectancy", 
       subtitle = "Data points are country-years", 
       caption = "Source: Gapminder.")
```

+ Make a nicer plot: 
    
    1. Set *alpha* of the points to a low value
    2. Make nice x- and y- axis labels
    3. Add a title, subtitle, and caption
    
+ Unless told otherwise, all geoms layered on top of the original plot object will inherit that object's mappings (everything inherits from "p")

```{r}
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp, color = continent))
p + geom_point() + geom_smooth(method = "loess") + scale_x_log10()
```

+ standard error ribbons are all gray. can be adjusted using *fill* 
+ *color* aesthetic affects appearance of lines and points
+ *fill* is for the filled areas of bars, polygons, and standard error ribbon

```{r}
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp, color = continent, fill = continent))
p + geom_point() + geom_smooth(method = "loess") + scale_x_log10()
```

+ Legend: the smoother understand both *color* (for the line itself) and *fill* (for the shaded standard error ribbon)

## Aesthetics can be mapped per Geom

+ By default, geoms inherit their mappings from ggplot()

```{r}
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp))
p + geom_point(mapping = aes(color = continent)) + 
  geom_smooth(method = "loess") + 
  scale_x_log10()
```

+ Legend : the points have *color*

    + Colored line and shaded box are both absent
    + We only see a legend for the mapping of *color* to *continent* in *geom_point()
    
+ Smoothing line drawn by geom_smooth() is set by default to bright blue with default shaded ribbon to gray

## Save your work

+ 

```{r}
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp))
p + geom_point(mapping = aes(color = log(pop))) + scale_x_log10()
```

+ Also possible to map continuous variables (rather than just categorical variables) to the *color* aesthetic too
+ When taking the log() of some data, ggplot produces a gradient scale

# Show the Right Numbers

```{r}

```


# Graph Tables, Make Labels, Add Notes

```{r}

```

# Work with Models

```{r}

```

# Draw Maps

```{r}

```


# Refine your Plots

```{r}

```


